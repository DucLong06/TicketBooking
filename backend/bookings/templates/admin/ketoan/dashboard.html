{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard K·∫ø To√°n{% endblock %}

{% block extrastyle %}
<style>
.dashboard { padding: 20px; max-width: 1900px; margin: 0 auto; }
.page-title { font-size: 28px; font-weight: bold; margin-bottom: 25px; color: #1976D2; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; }
.stat-label { font-size: 14px; opacity: 0.95; margin-bottom: 10px; }
.stat-value { font-size: 36px; font-weight: bold; }

.filter-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 15px; }
.filter-group { display: flex; flex-direction: column; }
.filter-group label { font-size: 13px; color: #666; margin-bottom: 5px; font-weight: 600; }
.filter-section select, .filter-section input[type="date"] { padding: 10px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; }
.filter-actions { display: flex; gap: 10px; align-items: center; }
.filter-section button { padding: 10px 24px; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
.filter-section button:hover { background: #1976D2; }
.clear-filter { color: #F44336; text-decoration: none; font-weight: 600; padding: 10px 20px; }
.clear-filter:hover { text-decoration: underline; }

.export-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.export-btn { display: inline-block; padding: 14px 28px; background: #4CAF50; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; }
.export-btn:hover { background: #45a049; }

.section-title { font-size: 20px; font-weight: bold; margin: 30px 0 15px 0; color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
.table-wrapper { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px; }
table { width: 100%; border-collapse: collapse; min-width: 1600px; }
th { background: #4472C4; color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 13px; white-space: nowrap; }
td { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
tr:hover { background: #f8f9fa; }
.booking-link { color: #2196F3; font-weight: 600; text-decoration: none; }
.invoice-box { background: #e8f5e9; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #4CAF50; font-size: 11px; }
.invoice-box p { margin: 2px 0; }
.notes-box { background: #fff9c4; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #FFC107; font-size: 11px; max-height: 60px; overflow-y: auto; }
.no-data { color: #999; font-style: italic; }
.badge-9pay { background: #FF6B35; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; }
.badge-no { background: #ddd; color: #666; padding: 3px 8px; border-radius: 3px; font-size: 11px; }

.inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
.perf-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.perf-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
.perf-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
.perf-date { font-size: 13px; opacity: 0.9; }
.summary-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
.summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
.summary-item { text-align: center; }
.summary-label { font-size: 12px; color: #666; margin-bottom: 5px; }
.summary-value { font-size: 24px; font-weight: bold; }
.cat-item { background: #f9f9f9; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea; }
.cat-name { font-weight: bold; display: flex; align-items: center; }
.cat-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 8px; }
.cat-numbers { display: flex; gap: 20px; font-size: 13px; }
.cat-numbers span { padding: 0 10px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <h1 class="page-title">üìä Dashboard K·∫ø To√°n</h1>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">Booking ƒë√£ l·ªçc</div>
            <div class="stat-value">{{ total_bookings }}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-label">C√≥ y√™u c·∫ßu xu·∫•t Hƒê</div>
            <div class="stat-value">{{ total_with_invoice }}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
            <div class="stat-label">T·ªïng doanh thu</div>
            <div class="stat-value">{{ total_revenue|floatformat:0 }} ‚Ç´</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);">
            <div class="stat-label">Thanh to√°n qua 9Pay</div>
            <div class="stat-value">{{ total_9pay }}</div>
        </div>
    </div>
    
    <div class="filter-section">
        <h3 style="margin: 0 0 15px 0;">üîç L·ªçc d·ªØ li·ªáu</h3>
        <form method="get" action="" id="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label>T·ª´ ng√†y:</label>
                    <input type="date" name="from_date" value="{{ from_date }}">
                </div>
                
                <div class="filter-group">
                    <label>ƒê·∫øn ng√†y:</label>
                    <input type="date" name="to_date" value="{{ to_date }}">
                </div>
                
                <div class="filter-group">
                    <label>V·ªü di·ªÖn:</label>
                    <select name="show" id="show-filter">
                        <option value="">-- T·∫•t c·∫£ --</option>
                        {% for show in shows %}
                        <option value="{{ show.id }}" {% if selected_show == show.id %}selected{% endif %}>
                            {{ show.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Su·∫•t di·ªÖn:</label>
                    <select name="performance" id="performance-filter">
                        <option value="">-- T·∫•t c·∫£ --</option>
                        {% for perf in performances %}
                        <option value="{{ perf.id }}" {% if selected_performance == perf.id %}selected{% endif %}>
                            {{ perf.show.name }} - {{ perf.datetime|date:"d/m/Y H:i" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="filter-actions">
                <button type="submit">L·ªçc</button>
                {% if selected_show or selected_performance or from_date or to_date %}
                <a href="?" class="clear-filter">‚úï X√≥a l·ªçc</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <div class="export-section">
        <h3 style="margin: 0 0 15px 0;">üì• Xu·∫•t d·ªØ li·ªáu</h3>
        <a href="{% url 'ketoan_admin:export_excel' %}?from_date={{ from_date }}&to_date={{ to_date }}&show={{ selected_show|default:'' }}&performance={{ selected_performance|default:'' }}" class="export-btn">
            üìä Xu·∫•t Excel ({{ total_bookings }} booking)
        </a>
    </div>
    
    <div class="section-title">üé´ Danh s√°ch Booking</div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>M√£</th>
                    <th>T√™n KH</th>
                    <th>SƒêT</th>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <th>Su·∫•t di·ªÖn</th>
                    <th>H·∫°ng v√©</th>
                    <th>S·ªë gh·∫ø</th>
                    <th>SL</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>9Pay</th>
                    <th>Th√¥ng tin Hƒê</th>
                    <th>Ghi ch√∫</th>
                    <th>Ng√†y TT</th>
                </tr>
            </thead>
            <tbody>
                {% for b in recent_bookings %}
                <tr>
                    <td><a href="{% url 'ketoan_admin:bookings_booking_change' b.id %}" class="booking-link">{{ b.booking_code }}</a></td>
                    <td><strong>{{ b.customer_name }}</strong></td>
                    <td>{{ b.customer_phone }}</td>
                    <td style="max-width: 150px;">{{ b.customer_address }}</td>
                    <td><strong>{{ b.performance.show.name }}</strong><br><small style="color:#666;">{{ b.performance.datetime|date:"d/m/Y H:i" }}</small></td>
                    <td>{{ b.ticket_classes }}</td>
                    <td style="max-width: 160px; font-size: 11px;" title="{{ b.seat_numbers }}">{{ b.seat_numbers }}</td>
                    <td style="text-align: center;"><strong>{{ b.seat_count }}</strong></td>
                    <td><strong style="color: #2196F3;">{{ b.final_amount|floatformat:0 }} ‚Ç´</strong></td>
                    <td style="text-align: center;">
                        {% if b.is_9pay %}
                        <span class="badge-9pay">‚úì</span>
                        {% else %}
                        <span class="badge-no">‚Äî</span>
                        {% endif %}
                    </td>
                    <td style="max-width: 200px;">
                        {% if b.invoice_info %}
                        <div class="invoice-box">
                            <p><strong>CT:</strong> {{ b.invoice_info.company_name }}</p>
                            <p><strong>MST:</strong> {{ b.invoice_info.tax_id }}</p>
                            <p><strong>Email:</strong> {{ b.invoice_info.email }}</p>
                        </div>
                        {% else %}
                        <span class="no-data">Kh√¥ng c√≥</span>
                        {% endif %}
                    </td>
                    <td style="max-width: 200px;">
                        {% if b.clean_notes %}
                        <div class="notes-box" title="{{ b.clean_notes }}">{{ b.clean_notes }}</div>
                        {% else %}
                        <span class="no-data">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>{{ b.paid_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="13" style="text-align:center;padding:60px;color:#999;">
                        Kh√¥ng c√≥ booking n√†o
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if inventory_data %}
    <div class="section-title">üìä S·ªë l∆∞·ª£ng v√© t·ªìn</div>
    
    <div class="inventory-grid">
        {% for perf_inv in inventory_data %}
        <div class="perf-card">
            <div class="perf-header">
                <div class="perf-title">{{ perf_inv.performance.show.name }}</div>
                <div class="perf-date">üìÖ {{ perf_inv.performance.datetime|date:"d/m/Y H:i" }} | üìç {{ perf_inv.performance.show.venue.name }}</div>
            </div>
            
            <div class="summary-box">
                <strong style="font-size: 14px; color: #333;">T·ªîNG QUAN</strong>
                <div class="summary-row">
                    <div class="summary-item">
                        <div class="summary-label">T·ªïng v√©</div>
                        <div class="summary-value">{{ perf_inv.total_seats }}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label" style="color: #F44336;">ƒê√£ b√°n</div>
                        <div class="summary-value" style="color: #F44336;">{{ perf_inv.sold_count }}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label" style="color: #4CAF50;">C√≤n tr·ªëng</div>
                        <div class="summary-value" style="color: #4CAF50;">{{ perf_inv.available_count }}</div>
                    </div>
                </div>
            </div>
            
            {% if perf_inv.categories %}
            <div style="margin-top: 15px;">
                <strong style="font-size: 13px; color: #666;">Chi ti·∫øt theo h·∫°ng v√©:</strong>
                {% for cat in perf_inv.categories %}
                <div class="cat-item" style="border-left-color: {{ cat.color }};">
                    <div class="cat-name">
                        <div class="cat-color" style="background-color: {{ cat.color }};"></div>
                        {{ cat.name }}
                    </div>
                    <div class="cat-numbers">
                        <span style="color: #666;"><strong>{{ cat.total }}</strong> t·ªïng</span>
                        <span style="color: #F44336;"><strong>{{ cat.sold }}</strong> b√°n</span>
                        <span style="color: #4CAF50;"><strong>{{ cat.available }}</strong> tr·ªëng</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
document.getElementById('show-filter').addEventListener('change', function() {
    const showId = this.value;
    if (showId) {
        const fromDate = document.querySelector('input[name="from_date"]').value;
        const toDate = document.querySelector('input[name="to_date"]').value;
        let url = '?show=' + showId;
        if (fromDate) url += '&from_date=' + fromDate;
        if (toDate) url += '&to_date=' + toDate;
        window.location.href = url;
    }
});
</script>
{% endblock %}