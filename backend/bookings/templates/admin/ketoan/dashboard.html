{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard K·∫ø To√°n{% endblock %}

{% block extrastyle %}
<style>
.dashboard { padding: 20px; max-width: 1900px; margin: 0 auto; }
.page-title { font-size: 28px; font-weight: bold; margin-bottom: 25px; color: #1976D2; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; }
.stat-label { font-size: 14px; opacity: 0.95; margin-bottom: 10px; }
.stat-value { font-size: 36px; font-weight: bold; }

.filter-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.filter-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.filter-section select { padding: 10px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-width: 250px; }
.filter-section button { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
.filter-section button:hover { background: #1976D2; }
.clear-filter { color: #F44336; text-decoration: none; font-weight: 600; padding: 10px 20px; }
.clear-filter:hover { text-decoration: underline; }

.export-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.export-btn { display: inline-block; padding: 14px 28px; background: #4CAF50; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; }
.export-btn:hover { background: #45a049; }

.section-title { font-size: 20px; font-weight: bold; margin: 30px 0 15px 0; color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
.table-wrapper { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px; }
table { width: 100%; border-collapse: collapse; min-width: 1400px; }
th { background: #4472C4; color: white; padding: 12px 10px; text-align: left; font-weight: 600; font-size: 13px; white-space: nowrap; }
td { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
tr:hover { background: #f8f9fa; }
.booking-link { color: #2196F3; font-weight: 600; text-decoration: none; }
.invoice-box { background: #e8f5e9; padding: 6px 10px; border-radius: 4px; border-left: 3px solid #4CAF50; font-size: 11px; }
.invoice-box p { margin: 2px 0; }
.no-invoice { color: #999; font-style: italic; }

.inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
.perf-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.perf-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
.perf-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
.perf-date { font-size: 13px; opacity: 0.9; }
.summary-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
.summary-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
.summary-item { text-align: center; }
.summary-label { font-size: 12px; color: #666; margin-bottom: 5px; }
.summary-value { font-size: 24px; font-weight: bold; }
.cat-item { background: #f9f9f9; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #667eea; }
.cat-name { font-weight: bold; display: flex; align-items: center; }
.cat-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 8px; }
.cat-numbers { display: flex; gap: 20px; font-size: 13px; }
.cat-numbers span { padding: 0 10px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard">
    <h1 class="page-title">üìä Dashboard K·∫ø To√°n</h1>
    
   
    
    <div class="filter-section">
        <h3 style="margin: 0 0 15px 0;">üîç L·ªçc d·ªØ li·ªáu</h3>
        <form method="get" action="" id="filter-form">
            <div class="filter-row">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">V·ªü di·ªÖn:</label>
                    <select name="show" id="show-filter">
                        <option value="">-- T·∫•t c·∫£ v·ªü di·ªÖn --</option>
                        {% for show in shows %}
                        <option value="{{ show.id }}" {% if selected_show == show.id %}selected{% endif %}>
                            {{ show.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #666;">Su·∫•t di·ªÖn:</label>
                    <select name="performance" id="performance-filter">
                        <option value="">-- T·∫•t c·∫£ su·∫•t di·ªÖn --</option>
                        {% for perf in performances %}
                        <option value="{{ perf.id }}" {% if selected_performance == perf.id %}selected{% endif %}>
                            {{ perf.show.name }} - {{ perf.datetime|date:"d/m/Y H:i" }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" style="margin-top: 20px;">L·ªçc</button>
                {% if selected_show or selected_performance %}
                <a href="?" class="clear-filter" style="margin-top: 20px;">‚úï X√≥a l·ªçc</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <div class="export-section">
        <h3 style="margin: 0 0 15px 0;">üì• Xu·∫•t d·ªØ li·ªáu</h3>
        <a href="{% url 'ketoan_admin:export_excel' %}{% if selected_performance %}?performance={{ selected_performance }}{% elif selected_show %}?show={{ selected_show }}{% endif %}" class="export-btn">
            üìä Xu·∫•t Excel{% if selected_performance %}: Su·∫•t ƒë√£ ch·ªçn{% elif selected_show %}: V·ªü ƒë√£ ch·ªçn{% else %}: T·∫•t c·∫£{% endif %}
        </a>
    </div>
    
    <div class="section-title">üé´ Danh s√°ch Booking{% if selected_performance or selected_show %} (ƒê√£ l·ªçc){% endif %}</div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>M√£ booking</th>
                    <th>T√™n KH</th>
                    <th>SƒêT</th>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <th>Su·∫•t di·ªÖn</th>
                    <th>H·∫°ng v√©</th>
                    <th>S·ªë gh·∫ø</th>
                    <th>SL v√©</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Th√¥ng tin h√≥a ƒë∆°n</th>
                    <th>Ng√†y TT</th>
                </tr>
            </thead>
            <tbody>
                {% for b in recent_bookings %}
                <tr>
                    <td><a href="{% url 'ketoan_admin:bookings_booking_change' b.id %}" class="booking-link">{{ b.booking_code }}</a></td>
                    <td><strong>{{ b.customer_name }}</strong></td>
                    <td>{{ b.customer_phone }}</td>
                    <td style="max-width: 180px;">{{ b.customer_address }}</td>
                    <td><strong>{{ b.performance.show.name }}</strong><br><small style="color:#666;">{{ b.performance.datetime|date:"d/m/Y H:i" }}</small></td>
                    <td>{{ b.ticket_classes }}</td>
                    <td style="max-width: 200px; font-size: 11px;" title="{{ b.seat_numbers }}">{{ b.seat_numbers }}</td>
                    <td style="text-align: center;"><strong>{{ b.seat_count }}</strong></td>
                    <td><strong style="color: #2196F3;">{{ b.final_amount|floatformat:0 }} ‚Ç´</strong></td>
                    <td style="max-width: 220px;">
                        {% if b.invoice_info %}
                        <div class="invoice-box">
                            <p><strong>CT:</strong> {{ b.invoice_info.company_name }}</p>
                            <p><strong>MST:</strong> {{ b.invoice_info.tax_id }}</p>
                            <p><strong>Email:</strong> {{ b.invoice_info.email }}</p>
                        </div>
                        {% else %}
                        <span class="no-invoice">Kh√¥ng c√≥</span>
                        {% endif %}
                    </td>
                    <td>{{ b.paid_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" style="text-align:center;padding:60px;color:#999;">
                        {% if selected_performance or selected_show %}
                        Kh√¥ng c√≥ booking n√†o cho b·ªô l·ªçc n√†y
                        {% else %}
                        Ch∆∞a c√≥ booking n√†o trong 7 ng√†y qua
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if inventory_data %}
    <div class="section-title">üìä S·ªë l∆∞·ª£ng v√© t·ªìn</div>
    
    <div class="inventory-grid">
        {% for perf_inv in inventory_data %}
        <div class="perf-card">
            <div class="perf-header">
                <div class="perf-title">{{ perf_inv.performance.show.name }}</div>
                <div class="perf-date">üìÖ {{ perf_inv.performance.datetime|date:"d/m/Y H:i" }} | üìç {{ perf_inv.performance.show.venue.name }}</div>
            </div>
            
            <div class="summary-box">
                <strong style="font-size: 14px; color: #333;">T·ªîNG QUAN</strong>
                <div class="summary-row">
                    <div class="summary-item">
                        <div class="summary-label">T·ªïng v√©</div>
                        <div class="summary-value">{{ perf_inv.total_seats }}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label" style="color: #F44336;">ƒê√£ b√°n</div>
                        <div class="summary-value" style="color: #F44336;">{{ perf_inv.sold_count }}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label" style="color: #4CAF50;">C√≤n tr·ªëng</div>
                        <div class="summary-value" style="color: #4CAF50;">{{ perf_inv.available_count }}</div>
                    </div>
                </div>
            </div>
            
            {% if perf_inv.categories %}
            <div style="margin-top: 15px;">
                <strong style="font-size: 13px; color: #666;">Chi ti·∫øt theo h·∫°ng v√©:</strong>
                {% for cat in perf_inv.categories %}
                <div class="cat-item" style="border-left-color: {{ cat.color }};">
                    <div class="cat-name">
                        <div class="cat-color" style="background-color: {{ cat.color }};"></div>
                        {{ cat.name }}
                    </div>
                    <div class="cat-numbers">
                        <span style="color: #666;"><strong>{{ cat.total }}</strong> t·ªïng</span>
                        <span style="color: #F44336;"><strong>{{ cat.sold }}</strong> b√°n</span>
                        <span style="color: #4CAF50;"><strong>{{ cat.available }}</strong> tr·ªëng</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
// Auto-reload performances when show changes
document.getElementById('show-filter').addEventListener('change', function() {
    const showId = this.value;
    if (showId) {
        // Redirect v·ªõi show parameter
        window.location.href = '?show=' + showId;
    }
});
</script>
{% endblock %}